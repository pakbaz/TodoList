name: Deploy Infrastructure & App

on:
  push:
    branches: [ main ]
    paths:
      - 'infra/**'
      - 'Dockerfile'
      - 'Program.cs'
      - 'TodoList.csproj'
      - 'Components/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'development'
        type: choice
        options:
        - development
        - production

permissions:
  id-token: write
  contents: read

env:
  TF_CLI_ARGS_apply: -auto-approve
  TF_IN_AUTOMATION: true
  ACR_IMAGE_NAME: todolist

jobs:
  terraform:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    defaults:
      run:
        working-directory: infra
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore & Build
        working-directory: .
        run: |
          dotnet restore TodoList.csproj
          dotnet build TodoList.csproj --configuration Release --no-restore

      - name: Run Tests (if any)
        working-directory: .
        run: |
          if ls *Tests*.csproj 1> /dev/null 2>&1; then
            dotnet test --no-build --configuration Release
          else
            echo "No test projects found - skipping"
          fi

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.5

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Verify Azure Authentication
        run: |
          echo "Testing Azure authentication..."
          az account show
          az group list --output table

      - name: Terraform Init
        timeout-minutes: 10
        run: |
          echo "Initializing Terraform..."
          terraform init -no-color
          echo "Terraform initialization completed"

      - name: Terraform Plan
        id: plan
        timeout-minutes: 15
        env:
          TF_LOG: INFO
          TF_VAR_environment: ${{ github.event.inputs.environment || 'dev' }}
          TF_VAR_location: ${{ vars.AZURE_LOCATION || 'centralus' }}
          TF_VAR_resource_group_name: ${{ vars.AZURE_RESOURCE_GROUP || 'rg-todolist-dev-centralus' }}
        run: |
          echo "Starting Terraform Plan..."
          echo "Environment: $TF_VAR_environment"
          echo "Location: $TF_VAR_location" 
          echo "Resource Group: $TF_VAR_resource_group_name"
          terraform plan -no-color -detailed-exitcode -out tfplan
          echo "Terraform plan completed successfully"

      - name: Terraform Apply
        if: github.ref == 'refs/heads/main'
        timeout-minutes: 30
        env:
          TF_LOG: INFO
        run: |
          echo "Starting Terraform Apply..."
          terraform apply -no-color tfplan
          echo "Terraform apply completed successfully"

      - name: Extract Outputs
        id: tfouts
        run: |
          echo "acr=$(terraform output -raw acr_login_server)" >> $GITHUB_OUTPUT
          echo "rg=$(terraform output -raw resource_group_name)" >> $GITHUB_OUTPUT
          echo "app=$(terraform output -raw container_app_name)" >> $GITHUB_OUTPUT
          echo "app_url=$(terraform output -raw container_app_url)" >> $GITHUB_OUTPUT

      - name: Derive ACR Name
        id: acrname
        run: |
          # login server like myacr.azurecr.io -> name before first dot
            ACR_NAME=$(echo "${{ steps.tfouts.outputs.acr }}" | cut -d'.' -f1)
            echo "acr_name=$ACR_NAME" >> $GITHUB_OUTPUT

      - name: Build & Push Image
        if: github.ref == 'refs/heads/main'
        run: |
          az acr login --name ${{ steps.acrname.outputs.acr_name }}
          docker build -t ${{ steps.tfouts.outputs.acr }}/${{ env.ACR_IMAGE_NAME }}:${{ github.sha }} ..
          docker push ${{ steps.tfouts.outputs.acr }}/${{ env.ACR_IMAGE_NAME }}:${{ github.sha }}

      - name: Update Container App Image
        if: github.ref == 'refs/heads/main'
        run: |
          az containerapp update \
            --name ${{ steps.tfouts.outputs.app }} \
            --resource-group ${{ steps.tfouts.outputs.rg }} \
            --image ${{ steps.tfouts.outputs.acr }}/${{ env.ACR_IMAGE_NAME }}:${{ github.sha }}
          echo "Application URL: https://${{ steps.tfouts.outputs.app_url }}" 
